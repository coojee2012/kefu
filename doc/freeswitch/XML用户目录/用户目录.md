# XML User Directory

## About

The FreeSWITCH $FS_ROOT/conf/directory/ contains accounts (i.e., XML files) for all users (i.e., SIP phone extensions) that may register to FS.

Note: This is not the same syntax which is used in the Dialplan

## User Settings

conf/directory/default/1000.xml Example

```xml
<include>
  <user id="1000" cidr="12.34.56.78/32,20.0.0.0/8">
  <!--ID is the required SIP username. CIDR is optional , if specified, these IPs automatically authenticate as this user.如果指定,这些IPs自动验证用户。-->
    <params>
      <param name="password" value="correcthorsebatterystaple"/> <!--SIP password-->
      <param name="vm-password" value="8761"/>
    </params>
    <variables> <!--these variable are accessible  可访问的 in the channel-->
      <variable name="accountcode" value="1000"/>
       <!--Use this in your dialplan for authorization and limits. Also, cdr_csv can use it for separate 单独的 CDR files-->
      <variable name="user_context" value="default"/>
      <!--magic variable: specifies the context, which translates to which dialplan will route outbound calls 
      神奇的变量:指定上下文,这意味着dialplan将路线出站调用-->
      <variable name="effective_caller_id_name" value="Extension 1000"/> <!--magic variable: used for outbound caller ID name-->
      <variable name="effective_caller_id_number" value="1000"/> <!--magic variable: used for outbound caller ID name/number-->
    </variables>
  </user>
</include>
```

Note that the "user" in the above directory snippet 片段 can be called in the dialplan bridge app with the user pseudo-endpoint.

`<action application="bridge" data="user/1000"/>`

## Basic User

The basic configuration is quite simple, you just need to add user names and passwords.
基本的配置很简单,你只需要添加用户名和密码。

In the file $FS_ROOT/conf/directory/mike_x2239.xml, for example, add:

```xml
<domain name="$${sip_profile}">
  <user id="mike">
    <params>
      <param name="password" value="micke"/>
    </params>
  </user>
</domain>
```

The domain tag tells FS to which domain this user belongs. Note that all users should be in the same domain tag, unless you are using multiple domains. The user name is the part left of @ in the sip address (in this case "mike" in "mike@sub.mydomain.com"). $${sip_profile} will be replaced with the domain that is specified in vars.xml.

a1-hash

A plaintext password may replaced with an "a1-hash". An a1-hash is generated by applying the MD5 digest function to the string "username:domain:password" (sans quotes). In Linux, the encoded password may be generated thusly:

`openssl dgst -md5 < filename, or echo -n "username:domain:password" | openssl dgst -md5`

conf/directory/mike_x2239.xml

```xml
<domain name="$${sip_profile}">
  <user id="mike">
    <params>
      <param name="a1-hash" value="c6440e5de50b403206989679159de89a"/>
    </params>
  </user>
</domain>
```

## Reverse Authentication 退还远程准入

Some endpoints require authentication for certain types of requests (ex. SIP NOTIFY for resync). You can specify the credentials used for this digest authentication.

conf/directory/default/jim_ra.xml

```xml
<domain name="$${sip_profile}">
  <user id="jim">
    <params>
       <param name="reverse-auth-user" value="jim" />
       <param name="reverse-auth-pass" value="foo123" />
    </params>
  </user>
</domain>
```

## VCards

You can also add support for vcards if you are using mod_dingaling. Then you add information in the following format:
你也可以加入如果你使用mod_dingaling支持电子名片。然后你添加信息在以下格式:
conf/directory/default/peters_dingaling.xml

```xml
<domain name="$${sip_profile}">
  <user id="peter">
    <params>
      <param name="password" value="thepassword"/>
    </params>
    <!-- This is only for mod_dingaling so it can deliver vcards in component mode-->
    <vcard xmlns='vcard-temp'>
      <FN>Peter Saint-Andre</FN>
      <N>
    <FAMILY>Saint-Andre</FAMILY>
    <GIVEN>Peter</GIVEN>
    <MIDDLE/>
      </N>
      <NICKNAME>stpeter</NICKNAME>
      <URL>http://www.jabber.org/people/stpeter.php</URL>
      <BDAY>1966-08-06</BDAY>
      <ORG>
    <ORGNAME>Jabber Software Foundation</ORGNAME>
    <ORGUNIT>Jabber Software Foundation</ORGUNIT>
      </ORG>
      <TITLE>Executive Director</TITLE>
      <ROLE>Patron Saint</ROLE>
      <TEL><WORK/><VOICE/><NUMBER>303-308-3282</NUMBER></TEL>
      <TEL><WORK/><FAX/><NUMBER/></TEL>
      <TEL><WORK/><MSG/><NUMBER/></TEL>
      <ADR>
    <WORK/>
    <EXTADD>Suite 600</EXTADD>
    <STREET>1899 Wynkoop Street</STREET>
    <LOCALITY>Denver</LOCALITY>
    <REGION>CO</REGION>
    <PCODE>80202</PCODE>
    <CTRY>USA</CTRY>
      </ADR>
      <TEL><HOME/><VOICE/><NUMBER>303-555-1212</NUMBER></TEL>
      <TEL><HOME/><FAX/><NUMBER/></TEL>
      <TEL><HOME/><MSG/><NUMBER/></TEL>
      <ADR>
    <HOME/>
    <EXTADD/>
    <STREET/>
    <LOCALITY>Denver</LOCALITY>
    <REGION>CO</REGION>
    <PCODE>80209</PCODE>
    <CTRY>USA</CTRY>
      </ADR>
      <EMAIL><INTERNET/><PREF/><USERID>stpeter@jabber.org</USERID></EMAIL>
      <JABBERID>stpeter@jabber.org</JABBERID>
      <DESC>
    More information about me is located on my
    personal website: http://www.saint-andre.com/
      </DESC>
    </vcard>
  </user>
</domain>
```

## Groups

A group is a logical collection of users that FreeSWITCH can use to bridge calls in a serial or parallel fashion, depending on the arguments to the group call application. Using groups is optional -- you can put your users straight into the domain section if you desire.

一组是一个逻辑的用户集合FreeSWITCH可以使用桥称串行或并行的方式,根据不同的参数组调用应用程序。使用组是可选的,你可以把你的用户直接进入域部分,如果你的愿望。

This is specially useful if you use mod_xml_curl to provide the user directory to FreeSWITCH and want to group some users in a logical structure. The following group '200' gathers four users. Note the "dial-string" param, which is used to bridge the calls to those users. Users 1000 and 1001 will use the default "dial-string" while user 2014 uses a loopback channel so FreeSWITCH can actually query the dialplan to figure out how to reach that user (this also works for external numbers through OpenZAP and gateways):

这是特别有用如果你使用mod_xml_curl FreeSWITCH提供用户目录,想组织一些用户在一个逻辑结构。以下组“200”收集四个用户。注意“dial-string”参数,用于通过bridge呼叫用户。用户1000和1001将使用默认的“dial-string”,而用户2014使用一个loopback channel 所以FreeSWITCH可以查询dialplan找出如何达到这一用户(这也适用于外部数字通过OpenZAP和网关):

The type="pointer" permits the same user to appear in multiple groups. It basically means to keep searching for the user in the directory.
type="pointer" 允许同一个用户出现在多个组。这基本上意味着继续寻找的用户目录。

```xml
<!-- Note: this example starts at the root of the FreeSWITCH XML tree -->
<document type="freeswitch/xml">
 <section name="directory">
   <domain name="sip.example.com">
     <users>
       <user id="1000">
         <params>
           <param name="dial-string" value="{presence_id=${dialed_user}@${dialed_domain}}${sofia_contact(${dialed_user}@${dialed_domain})}"/>
         </params>
         <variables>
           <variable name="user_context" value="default"/>
         </variables>
       </user>
       <user id="1001">
         <params>
           <param name="dial-string" value="{presence_id=${dialed_user}@${dialed_domain}}${sofia_contact(${dialed_user}@${dialed_domain})}"/>
         </params>
         <variables>
           <variable name="user_context" value="default"/>
         </variables>
       </user>
     </users>
     <groups>
       <group name="200">
         <users>
           <user id="2014">
             <params>
               <param name="dial-string" value="loopback/2014/default/XML"/>
             </params>
             <variables>
               <variable name="user_context" value="default"/>
             </variables>
           </user>
           <user id="1000" type="pointer"/>
           <user id="1001" type="pointer"/>
         </users>
       </group>
     </groups>
   </domain>
 </section>
</document>
```

The dialplan for the above group can be defined like this:

```xml
<extension name="Group 200">
  <condition field="destination_number" expression="200">
    <action application="set" data="hangup_after_bridge=true"/>
    <action application="set" data="continue_on_fail=true"/>
    <action application="set" data="originate_continue_on_timeout=true"/>
    <action application="set" data="call_timeout=15"/>
    <action application="bridge" data="${group_call(200@${domain_name}+F)}"/>
    <action application="transfer" data="200 XML default"/>
    <action application="hangup"/>
  </condition>
</extension>
```

The extension 200 will ring all the users defined in the user directory for group 200 in a serial fashion 串行方式 (specified by the +F argument, if you want to ring all the users at once use the +A argument) for 15 seconds, then it will transfer the call to the same group again so the call will ring the group infinitely 无限.

To explain the variables set prior to the bridge: 解释bridge前设置的变量:

The hangup_after_bridge is set to true for this effect: if the bridge is successfully answered and the B-leg later hangs up, the A-leg will also be hung up.

The continue_on_fail is set to true for this: if the bridge fails, dialplan execution will continue and the transfer will be executed.

The originate_continue_on_timeout is set to true for this: if the bridge's dial string specifies several destinations separated by the "|" (this is for failover), the bridge will time out on an unanswered destination and will attempt the next specified destination.

Without originate_continue_on_timeout set to true, the bridge will time out on the first destination it tries and the bridge itself will fail.
没有将originate_continue_on_timeout设置为true,bridge尝试第一目的地失败后，bridge本身将会失败

(In the example above, the bridge string is generated by group_call with the +F option; this specifies a dial string with all the group's destinations separated by "|". So originate_continue_on_timeout needs to be set to true for serial calling behavior.)

The call_timeout is set so that the bridge attempt to a destination that goes unanswered will time out.

NOTE: If the destination sends early media, the bridge will be answered (pre-answered) and will NOT time out! To time out a bridge attempt to a destination sending early media, set ignore_early_media to true.

The dialplan for user 2014, which in this example happens to be terminated through a gateway defined via mod_lcr, can be defined like this:

```xml
<extension name="Extension 2014">
  <condition field="destination_number" expression="2014">
    <action application="lcr" data="2014"/>
    <action application="set" data="dialed_ext=${lcr_auto_route}"/>
    <action application="export" data="dialed_ext=${lcr_auto_route}"/>
    <action application="set" data="hangup_after_bridge=true"/>
    <action application="set" data="call_timeout=120"/>
    <action application="bridge" data="${lcr_auto_route}"/>
    <action application="hangup"/>
  </condition>
</extension>
```

## Alphanumeric to Numeric User Mapping 字母数字数字用户映射

Say you want a user's id to be alphanumeric 字母数字 (like an email username), such as johnsmith@pbx.example.com These users have alphanumeric usernames in their sip phone config, but you want to map them from their sip username to a numeric extension, and vice versa.

As of version 1.0.4, FreeSWITCH makes this trivial to accomplish FreeSWITCH使这个简单的完成. A user's ID can be any alphanumeric string, and this can be simply tied to an extension number using the 'number-alias' property. This property creates an aliased directory entry that points to the alphanumeric user entry.

Be sure to edit your dialplan/default.xml file to include not only the user id (johnsmith in our example), but also the number-alias (1001). Keep in mind that user IDs are case sensitive.

When using this attribute, you must be careful not to create a directory collision by having another user whose ID is the same as another user's alias

Here is an example from the user directory:

number-alias Example

```xml
<user id="johnsmith" number-alias="1001">
  <!-- Insert the usual user configuration variables and params here,
       including user password, voicemail password, caller ID info, etc -->
   <variables>
     <variable name="mailbox" value="1001"/>
     <variable name="effective_caller_id_name" value="1001"/>
     <variable name="effective_caller_id_number" value="1001"/>
     <variable name="voicemail_alternate_greet_id" value="1001"/>
   </variables>
</user>
```

So when a user dials extension number 1001, your dialplan can use the 'user_data' function to look up the ID attribute associated with that number alias. In the default dialplan, the 'Local Extension' section can be made to work with a small change to the 'bridge' line:

`<action application="bridge" data="user/${user_data(${destination_number}@${domain_name} attr id)}"/>`

Using this user_data function in combination with mod_xml_curl will generate an additional request each time the user_data function is called. Note that it is already called once in the Local Extension section of the default vanilla dialplan to determine the callgroup. Beware of the performance implications of this with high-volume systems.

## More Complex Examples

Each `<user>` can also have it's own variables and gateways with their own special configurations.
每个`<user>`也可以有它自己的变量和网关的特殊配置。

User-Specific Gateways

```xml
<user id="user1">
  <params>
    <param name="password" value="1"/>
  </params>
  <variables>
    <variable name="register-gateway" value="user1out"/>
  </variables>
  <gateways>
    <gateway name="user1out">
      <param name="username" value="4347382173"/>
      <param name="password" value="1"/>
      <param name="proxy" value="sip.example.com"/>
      <param name="register" value="false"/>
    </gateway>
  </gateways>
</user>
```

The `<register-gateway>` variable can be set to the name of a specific gateway, a comma delimited list of multiple gateways, or "all". Setting it to one or more gateways will register the named gateway(s) when the `<user>` registers with FreeSWITCH.(whether they're in this user's `<gateways>` or some other user's `<gateways>` or anywhere). Setting the variable to "all" will register all of the particular user's gateways.

变量`<register-gateway>` 可以设置为一个特定的网关名字,一个逗号分隔的多个网关名字列表,或“all”。设置一个或多个网关将注册指定的网关当用户注册FreeSWITCH时。

## Group Call with Answer Confirmation 集团电话回答确认

The following example makes the user reachable at multiple phone numbers in SIP and PSTN networks. A call to a mobile phone may usually be answered with a message that a mobile user is unreachable, or end up in a voicemail. In order to avoid such situations, group_confirm_key is used to request the user to press "1" for call confirmation.

下面的示例让用户可以在SIP和PSTN网络的多个电话号码。呼叫手机通常会回答移动用户无法访问的消息,或语音信箱结束。为了避免这种情况,group_confirm_key用于请求用户按下“1”进行电话确认。

Loopback endpoint duplicates all channel variables, so if group_confirm_key is set globally, the confirmation key would be asked twice. So it needs to be applied with [] to limit to one leg only. The loopback endpoint is used to route the call to a PSTN number, assuming that users in the default context are allowed to dial international numbers and they are routed to an appropriate gateway.
Loopback端点重复所有通道变量,所以如果group_confirm_key设置在全局范围内,将要求确认键两次。因此它需要被应用与[]来限制只有one leg。loopback端点用于将呼叫路由到PSTN数字,假设用户默认上下文允许拨打国际号码和路由到一个适当的网关。

```xml
<!-- dialplan/default.xml -->
   <extension name="global" continue="true">
     <condition>
       <action application="set" data="group_confirm_file=phrase:press_one_to_answer"/>
       <action application="set" data="group_confirm_read_timeout=1000"/>
     </condition>
   </extension>
   <extension name="dvop_groupcall">
     <condition field="destination_number" expression="^(71[1-9]0)$">
       <action application="answer"/>
       <action application="set" data="ringback=$${hold_music}"/> 
       <action application="set" data="call_timeout=60"/>
       <action application="set" data="hangup_after_bridge=true"/>
       <action application="bridge" data="${group_call(hunt_$1@${domain_name}+A)}"/>
     </condition>
   </extension>

```

```xml
 <!-- directory/default.xml -->
    <users>
      <user id="7012">
        <params>
          <param name="a1-hash" value="538db5a1dcf95cd9df62bf2ff0466c4b"/>
        </params>
        <variables>
          <variable name="user_context" value="default"/>
        </variables>
      </user>
      <user id="7017">
        <params>
          <param name="dial-string" value="[group_confirm_key=1]loopback/00491637743380/default"/>
        </params>
      </user>
    </users>
    <groups>
      <group name="hunt_7190">
        <users>
          <user id="7012" type="pointer"/>
          <user id="7017" type="pointer"/>
        </users>
      </group>
    </groups>
```

## Domains & Users Parameters

`<params>` and `<variables>` tags are valid inside 是有效的 `<user>`, `<group>` and `<domain>` tags.

Parameters and variables set on the domain will apply to all users in the domain, and parameters and variables set in a group will apply to all users in the group.

Priority will be given to identical parameters and variables in the following order: users, groups, domain.
将会优先给予相同的参数和变量按照以下顺序: users, groups, domain.

## Password

`<param name="password" value="123456"/>`
Do Not Allow Empty Passwords
If you do not include the above 'password' parameter, anybody can register as the user without using a password. It is always wise to include this parameter in the directory section in case a user does not set their password.
如果你不包括上面的“password”参数,任何人都可以注册为用户不使用一个密码。它总是明智的这个参数包含在目录部分,以防用户不设置自己的密码。

`<param name="allow-empty-password" value="false"/>`

## Dial String

The dial string MUST be defined and will control the behavior of the call when a user is dialed. The dial-string parameter is used by the user/ endpoint.
拨号字符串必须定义，它将控制呼叫的行为，当用户被拨打时。dial-string参数被user/ endpoint使用 。

Default value goes as follows:

`<param name="dial-string" value="${sofia_contact(${dialed_user}@${dialed_domain})}"/>`

Channel Variables Useful for the Dial String

transfer_fallback_extension
presence_id

`<param name="dial-string" value="{transfer_fallback_extension=${dialed_user}}${sofia_contact(${dialed_user}@${dialed_domain})}"/>`
Include Pickup Endpoints

`<param name="dial-string" value="${sofia_contact(${dialed_user}@${dialed_domain})},pickup/${dialed_user}@${dialed_domain}"/>`

### Advanced Dial String

Sets presence and creates pickup endpoint

`<param name="dial-string" value="{sip_invite_domain=${dialed_domain},presence_id=${dialed_user}@${dialed_domain}}${sofia_contact(${dialed_user}@${dialed_domain})},pickup/${dialed_user}@${dialed_domain}"/>`

## Variables

Any variables defined in the domain or user will be defined as channel variables when there is a call to that user or when there is a call initiated by that user. These variables can be read in the dialplan and can affect the handling of the call.

### Forcing a Particular User to a Particular Extension 迫使一个特定用户特定的扩展

In a PABX environment, an authenticated user can specify that they are at an arbitrary extension. This behavior can be restricted in two ways.

To force a user to use a specified extension, add

`<variable name="sip-force-user" value="<extension>"/>`
to that user's directory entry.

Alternatively另外, to check that users authenticate with the same username as that in their contact field for an entire profile, add

`<variable name="inbound-reg-force-matching-username" value="true"/>`
to that profile's definition.

Additionally look at JIRA ticket FS-5119 - easy way of registration user with different SIP ID (Contact header) and username (Authorization header).

### Force Registrations to Expire

To help prevent stale registrations you are able to override the client–specified registration expiry. You do this in the client's directory profile, by simply adding the variable
有助于防止过期注册你可以覆盖客户机指定注册到期。在客户机的目录配置文件,只需添加变量
`<variable name="sip-force-expires" value="180"/>`