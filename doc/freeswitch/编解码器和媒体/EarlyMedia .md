# Early Media 早期媒体

早期媒体指在建立一个连接之前交换的信息。如彩铃或特定回铃音

## About

The concept of "early media" can sometimes confuse those new to telephony. RFC 3960 defines it this way:
“早期媒体”的概念有时会混淆这些新的电话。RFC 3960定义了这样:
   Early media refers to media (e.g., audio and video) that is exchanged
   before a particular session is accepted by the called user.  Within a
   dialog, early media occurs from the moment the initial INVITE is sent
   until the User Agent Server (UAS) generates a final response.  It may
   be unidirectional or bidirectional, and can be generated by the
   caller, the callee, or both.
   早期的媒体是指媒体(比如音频和视频)交换在一个特定的会话被称为用户接受。在一个对话中,发生早期媒体从最初的邀请发送直到用户代理服务器(UAS)生成一个最终响应。它可能是单向或者双向的,可以生成的被调用者,或两者兼而有之。
The expression "early media" seems to be quite SIP-oriented but the concept of early media is not. Everyone who has ever used a telephone and heard a ring signal or a busy signal is familiar with the concept of early media. Circuit-switched telephony used the term 'supervision' to indicate start of billing and beginning of the telephony session (connection). In simple terms:
表达“早期媒体”的概念似乎很SIP-oriented但早期媒体不是。每个人都曾经使用过一个电话,听到一个环信号或一个繁忙的信号早期媒体熟悉的概念。电路交换电话使用术语“监督”,表示开始计费和开始电话会议(连接)。简而言之:
Early media is the exchange of information before establishment of a connection
早期媒体指在建立一个连接之前交换的信息。
The best way to illustrate that is by looking at a traditional telephone call where party A calls party B:
说明,最好的办法是通过传统的电话,A呼叫B:
Party A picks up her phone, hears dial-tone, and enters a phone number
After a few moments, she hears ringing. (This is "early" media because the call hasn't been answered yet)
Meanwhile party B's phone starts to ring
After a few rings, party B picks up, and a call is established.
Party A and party B can now hear each other speak.
Another good example is what happens on a busy signal. Using the same parties from the previous example:

Party A picks up her phone, hears dial-tone, and enters a phone number
After a few moments, she hears a busy signal. (This is "early" media - no call has been established)
Party A hangs up
The busy signal is an audible signal - a form of audio media if you will - that lets the calling party know that the call has not gone through. It is an unconnected call, but it still had sound. In a case of per-call billing, this call would not be billed (usually) because it was never connected. The same holds true for calls that are ring/no answer. It even holds true for calls to disconnected numbers where you hear the Special Information Tones (SIT) and a recorded message.

## Triggering early media 引发早期媒体

On an inbound call you can execute pre_answer to trigger early media. After this you can do ringback, play a file or whatever.
在一个入站呼叫可中，以执行pre_answer引发早期媒体。之后你可以ringback或播放一个文件或其他。

## Early Media And Dialing Out

FreeSWITCH has many options for handling early media. The one to use will depend greatly on your needs. By default FreeSWITCH "listens" for early media and acts accordingly. You may also ignore early media altogether. Finally, there is new hybrid functionality that can offer some of the benefits of both listening to and ignoring early media.
FreeSWITCH早期媒体有许多选项来处理。一个使用在很大程度上取决于您的需要。默认情况下FreeSWITCH“听”早期媒体并采取相应行动。你也可以完全忽略早期媒体。最后,还有新的混合功能的,可以提供一些好处听和忽视早期媒体。

## A "Successful" Call Attempt 一个“成功”呼叫尝试

In the default mode, a call attempt is "successful" if it returns early media. Conversely, if the call does not return early media at all or returns some specific error then the call attempt is not successful. Consider some examples:
在默认模式中,如果它返回早期的媒体呼叫尝试是“成功”的。相反,如果呼叫不返回早期媒体,或者返回一些特定的错误然后呼叫尝试不成功。考虑一些例子:
Ringing - successful
Busy - successful
Invalid phone number - unsuccessful
All circuits busy - unsuccessful
As you can see, there is a difference between successfully attempting a call and successfully connecting a call.
正如你所看到的,是有区别的成功尝试,成功连接电话的电话。

## Ignoring Early Media

In some cases you don't care whether the call attempt was successful - you simply need to know if the call was connected or not. In those cases, it is possible to ignore early media when dialing.
在某些情况下你不在乎呼叫尝试是否成功——你只需要知道呼叫连接与否。在这些情况下,可以忽略早期媒体当拨号。
`{ignore_early_media=consume}sofia/internal/user@domain`
If you want block early media from remote end then

`{ignore_early_media=true}sofia/internal/user@domain`
Without ignore_early_media, the originate will be considered success when it gets early media.
没有ignore_early_media,来源于早期媒体将被视为成功的时候。
Ignoring Ring Ready (180)
You can ignore ring ready (180) but still "react" when receiving a 183 with media:

`{ignore_early_media=ring_ready}sofia/internal/user@domain`
ignore_early_media=ring_ready works the same way as ignore_early_media=true, but it also sends 180 to the inbound leg when the first 183 is caught.

## Monitoring Early Media

As of FreeSWITCH 1.0.3, a new method is available: monitoring early media. As its name implies, it does not ignore early media outright, nor does it assume any early media is a successful call attempt. See:

monitor_early_media_ring
monitor_early_media_fail

## Early Media and "Late Negotiation"

Stub - more to come

## Troubleshooting 故障排除

Be certain that you have inbound-bypass-media turned off 确定你是否关闭inbound-bypass-media

## See also

ignore_early_media channel variable
draft-barnes-sip-em-ps-req-sol-00 - Early Media in SIP: Problem Statement, Requirements, and Analysis of Solutions

## 180 vs 183 vs Early Media

If you know that the phone is ringing (an ALERT Q.931 message, for instance) you send a 180 Ringing.

If you receive a notification indicating that the call is progressing, but you do not know for sure whether the user is being alerted or not, you send a 183 Session Progress message.
如果你收到通知指示呼叫正在进行,但是你不确定用户是否被提醒,你发送一个183会话进展消息。

Both can indicate early media with SDP. If there is no SDP, the end device (softphone/gateway/etc.) has to generate the ringback tone or progress tone.
两者都可以通过SDP表明早期媒体。如果没有SDP,终端设备(软电话/网关/等)生成回铃应或进展的音调。

Usually you will see 180 without SDP while 183 with SDP. It is a good practice to leave the tone generation for the endpoints.

If you get 183 you should open media connection because there is audio ready for them to hear.

If you set ringback var and ignore_early_media, both 180 and 183 will trigger your fake ringing. If you set instant_ringback=true then it will not wait for 18x it will start fake ringback instant (asterisk mode).
